{% extends "examples_base.html" %}

{% block content %}

{% block howto_content %}
<div class="container-fluid px-0">
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-light">
      <h5 class="mb-0">How to Build: Bulk Update</h5>
    </div>
    <div class="card-body">
  <h6 class="text-uppercase text-muted small fw-bold mb-3">Step 1: The View</h6>
  <pre class="bg-light p-3 rounded small mb-4"><code class="language-python"># views.py
def bulk_update_view(request):
    contacts = Contact.objects.all()[:10]
    return render(request, 'bulk_update.html', {'contacts': contacts})

def bulk_update_update_view(request):
    ds = DjangoDatastar(request)
    selected_ids = request.POST.getlist('selected_ids')
    action = request.POST.get('action')

    if action == 'delete' and selected_ids:
        Contact.objects.filter(pk__in=selected_ids).delete()

    remaining_contacts = Contact.objects.all()[:10]
    return ds.fragment(render_to_string('fragments/contact_table.html', {
        'contacts': remaining_contacts
    }))</code></pre>

  <h6 class="text-uppercase text-muted small fw-bold mb-3">Step 2: The URL</h6>
  <pre class="bg-light p-3 rounded small mb-4"><code class="language-python"># urls.py
path('bulk-update/', views.bulk_update_view, name='bulk-update'),
path('bulk-update/update/', views.bulk_update_update_view, name='bulk-update-update'),</code></pre>

  <h6 class="text-uppercase text-muted small fw-bold mb-3">Step 3: The Template</h6>
  <pre class="bg-light p-3 rounded small mb-4"><code class="language-django">&lt;form id="bulk-form"&gt;
  &lt;table&gt;
    &lt;thead&gt;
      &lt;tr&gt;
        &lt;th&gt;
          &lt;input
            type="checkbox"
            data-on:change__prevent="@document.querySelectorAll('.contact-checkbox').forEach(cb => cb.checked = $event.target.checked)"
          &gt;
        &lt;/th&gt;
        &lt;th&gt;Name&lt;/th&gt;
      &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody id="contact-table"&gt;
      {% for contact in contacts %}
      &lt;tr&gt;
        &lt;td&gt;
          &lt;input type="checkbox" class="contact-checkbox" value="{{ contact.pk }}"&gt;
        &lt;/td&gt;
        &lt;td&gt;{{ contact.first_name }}&lt;/td&gt;
      &lt;/tr&gt;
      {% endfor %}
    &lt;/tbody&gt;
  &lt;/table&gt;

  &lt;select name="action"&gt;
    &lt;option value="delete"&gt;Delete selected&lt;/option&gt;
  &lt;/select&gt;

  &lt;button
    type="submit"
    data-on:submit__prevent="@post('{% url 'examples:bulk-update-update' %}', {params: {selected_ids: [...], action: 'delete'}})"
  &gt;Apply&lt;/button&gt;
&lt;/form&gt;</code></pre>

  <h6 class="text-uppercase text-muted small fw-bold mb-3">Step 4: The Fragment</h6>
<pre class="bg-light p-3 rounded small"><code class="language-django">&lt;tbody id="contact-table"&gt;
  {% for contact in contacts %}
  &lt;tr&gt;
    &lt;td&gt;&lt;input type="checkbox" value="{{ contact.pk }}"&gt;&lt;/td&gt;
    &lt;td&gt;{{ contact.first_name }} {{ contact.last_name }}&lt;/td&gt;
    &lt;td&gt;{{ contact.email }}&lt;/td&gt;
  &lt;/tr&gt;
  {% endfor %}
&lt;/tbody&gt;</code></pre>
    </div>
  </div>
</div>
{% endblock howto_content %}

<div class="container py-5">
  <nav class="mb-4">
    <a href="{% url 'examples:index' %}" class="text-decoration-none">&larr; Back to Examples</a>
  </nav>

  <header class="mb-5">
    <h1 class="h2">Bulk Update</h1>
    <p class="text-muted">Select multiple items and update them together</p>
  </header>

  <section class="card shadow-sm mb-4">
    <div class="card-body">
      <h2 class="h5 mb-3">How it Works</h2>
      <ol class="text-muted small">
        <li>Checkboxes allow selecting multiple contacts</li>
        <li>Select an action (Delete selected)</li>
        <li>Form submits selected IDs to <code>/bulk-update/update/</code></li>
        <li>Server processes batch and returns updated table fragment</li>
      </ol>
    </div>
  </section>

  <div class="card shadow-sm">
    <div class="card-body">
      <form id="bulk-form">
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>
                  <input
                    type="checkbox"
                    class="form-check-input"
                    data-on:change__prevent="@document.querySelectorAll('.contact-checkbox').forEach(cb => cb.checked = $event.target.checked)"
                  />
                </th>
                <th>Name</th>
                <th>Email</th>
              </tr>
            </thead>
            <tbody id="contact-table">
              {% include 'examples/fragments/contact_table.html' %}
            </tbody>
          </table>
        </div>

        <div class="d-flex gap-2 align-items-center">
          <select name="action" class="form-select" style="width: auto;">
            <option value="">Select action...</option>
            <option value="delete">Delete selected</option>
          </select>
          <button
            type="submit"
            class="btn btn-primary"
            data-on:submit__prevent="@post('{% url 'examples:bulk-update-update' %}', {params: {selected_ids: Array.from(document.querySelectorAll('.contact-checkbox:checked')).map(cb => cb.value)}})"
          >
            Apply
          </button>
        </div>
      </form>
    </div>
  </div>

  <section class="card shadow-sm mb-4">
    <div class="card-body">
      <h2 class="h5 mb-3">Learn More</h2>
      <ul class="mb-0">
        <li><a href="/docs/datastar-guide/django-forms-integration.md" style="color: #6B46C1; text-decoration: none;">Django Forms Integration</a></li>
        <li><a href="/docs/datastar-guide/best-practices.md#6-business-isolation" style="color: #6B46C1; text-decoration: none;">Business Isolation</a></li>
        <li><a href="/docs/datastar-guide/core-concepts.md#partial-templates" style="color: #6B46C1; text-decoration: none;">Partial Templates</a></li>
      </ul>
    </div>
  </section>
</div>
{% endblock content %}
